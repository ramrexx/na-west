---
- name: Manage untagged ec2 instances
  hosts: localhost
  become: true
  vars:
    aws_access_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37363734353335313637366331356533316266633138303862616232356131323634353739656339
          6432653036343664396137616637666639333137373263320a653765373762313162303834643264
          62333165383531323130653663306332393766646137323963333465326432666663666261333061
          3534306266373064660a613537643536343636303262376166643164363966633934346437303830
          63363039366562663165653633653638356636636263316637343233343532353330
    aws_secret_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36623233666135666666326331653235636234313462623164343730656338363065653764383734
          3966373363373938616239656564666135333030613133330a653030396232663063663666393962
          65383336333334333363323762306561316238393662326166303833343831653636343331333362
          3336666666326236340a646137303835663761653162303531636565626665343038626439373061
          35373163366531663638323437636362373466653931393261373265373462333164393462333630
          3932353936373261653731313463626431353035666134346639
    region: us-west-2
    wait_for_stop: False

  tasks:
    - name: Build a list of instances
      ec2_instance_info:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ region }}"
      register: aws_instances

    - name: Count aws_instances
      debug:
        var: aws_instances | length

    - name: Filter instances based on AlwaysUp:NO tag or missing tag
      set_fact:
        instance_ids: "{{ aws_instances | json_query(aws_query) }}"
      vars:
        aws_query: "instances[?tags.AlwaysUp!='YES'].instance_id"

    - name: Log instance_ids
      debug:
        var: instance_ids

    - name: Assign missing AlwaysUp tag
      ec2_tag:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ region }}"
        resource: "{{ item }}"
        state: present
        tags:
          AlwaysUp: 'NO'
      with_items: "{{ instance_ids }}"

    - name: Stop the AlwaysUp:NO instances
      ec2:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        region: "{{ region }}"
        instance_ids: "{{ instance_ids }}"
        state: stopped
        wait: "{{ wait_for_stop }}"
